var _gaq=_gaq||[];function init(){var t=document.getElementById("SearchInput");t.addEventListener("input",handleInput),t.addEventListener("keydown",function(e){"13"==e.keyCode&&handleSearch(),"38"!=e.keyCode&&"40"!=e.keyCode||(e.returnValue=!1)}),document.addEventListener("click",function(e){"SearchInput"===e.target.id&&t.value.length<=0?showSearchHistory():hideSuggest()}),document.addEventListener("keydown",handleSuggestList),document.getElementById("SearchButton").onclick=handleSearch,document.getElementById("google").onclick=function(){chrome.runtime.sendMessage({op:"openGoogle"})},document.getElementById("OALib").onclick=function(){chrome.tabs.create({url:"http://www.oalib.com/"})},document.getElementById("SCI").onclick=function(){chrome.tabs.create({url:"http://www.sci-hub.cn/"})},document.getElementById("ISI").onclick=function(){chrome.tabs.create({url:"http://webofknowledge.com/"})},document.getElementById("LibGen").onclick=function(){chrome.tabs.create({url:"http://libgen.io/"})},document.getElementById("BookSC").onclick=function(){chrome.tabs.create({url:"http://booksc.org/"})},document.getElementById("PirateBay").onclick=function(){chrome.runtime.sendMessage({op:"openPirateBay"})},document.getElementById("cqvip").onclick=function(){chrome.tabs.create({url:"http://cqvip.com/"})},document.getElementById("cnki").onclick=function(){chrome.tabs.create({url:"http://www.cnki.net/"})},document.getElementById("wanfangdata").onclick=function(){chrome.tabs.create({url:"http://www.wanfangdata.com.cn/"})},document.getElementById("baiduxueshu").onclick=function(){chrome.tabs.create({url:"http://xueshu.baidu.com/"})},document.getElementById("allwebsite").onclick=function(){chrome.tabs.create({url:"http://kbs.cnki.net/"})},chrome.storage.local.get("enableProxy",function(e){document.getElementById("enableProxy").checked=void 0===e.enableProxy||e.enableProxy}),document.getElementById("enableProxy").onclick=function(){chrome.runtime.sendMessage({op:"switchProxy",enableProxy:this.checked})},initAnalytics()}function handleSearch(){chrome.runtime.sendMessage({op:"requestGoogleScholar"},function(e){if(e&&e.url&&0<e.url.length){var t=document.getElementById("SearchInput").value;t.length<=0?chrome.tabs.create({url:e.url}):chrome.tabs.create({url:e.url+"?q="+encodeURIComponent(t)})}else startSearch()})}function startSearch(){var e=document.getElementById("SearchInput");if(e.value.length<=0)chrome.tabs.create({url:"https://scholar.google.com/"});else{chrome.tabs.create({url:"https://scholar.google.com/scholar?q="+encodeURIComponent(e.value)});var t=new Array,n=getCookie("historySearch");0<n.length&&(t=JSON.parse(n));for(var o=0;o<t.length;++o)if(decodeURIComponent(JSON.parse(t[o]).data)===e.value){t.splice(o,1);break}t.sort(function(e,t){return t.inputTime-e.inputTime}),t.unshift(JSON.stringify({data:encodeURIComponent(e.value),inputTime:(new Date).getTime()})),6<t.length&&t.splice(6,t.length-6),setCookie("historySearch",JSON.stringify(t),31536e4)}}function handleInput(){var e=this.value;e.length<=0?showSearchHistory():(this.setAttribute("UserInputValue",this.value),sendHttpRequest("https://scholar.google.com/scholar_complete?q="+encodeURIComponent(e),function(e){if(200===e.httpCode){var t=null;try{t=JSON.parse(e.responseText)}catch(e){t=null}t.hasOwnProperty("l")&&isArray(t.l)&&showSuggest(t.l)}}))}function sendHttpRequest(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.onreadystatechange=function(){4==n.readyState&&t({httpCode:n.status,responseText:n.responseText})},n.send(null)}function setCookie(e,t,n){if(0<n){var o=new Date;o.setTime((new Date).getTime()+1e3*n),document.cookie=e+"="+encodeURIComponent(t)+";expires="+o.toUTCString()}else document.cookie=e+"="+encodeURIComponent(t)}function getCookie(e){for(var t=e+"=",n=document.cookie.split(";"),o=0;o<n.length;++o){var c=n[o].trim();if(0==c.indexOf(t))return decodeURIComponent(c.substring(t.length,c.length))}return""}function showSearchHistory(){var e=getCookie("historySearch");if(0<e.length){for(var t=new Array,n=JSON.parse(e),o=0;o<n.length;++o)t.unshift(decodeURIComponent(JSON.parse(n[o]).data));showSuggest(t,!0)}else hideSuggest()}function showSuggest(e,t){if(!(e.length<=0)){var n=document.getElementById("SearchInput"),o=document.getElementById("suggestList");o.innerHTML="";for(var c=0;c<e.length&&!(6<=c);++c){var r=document.createElement("div");r.innerHTML=e[c],r.setAttribute("class","suggestItem"),r.onclick=function(){n.value=this.innerHTML,handleSearch()},o.appendChild(r)}if(t){var s=document.createElement("div");s.innerHTML="清除历史搜索记录",s.setAttribute("class","suggestItem"),s.onclick=function(){setCookie("historySearch","",1)},o.appendChild(s)}o.style.display="block"}}function hideSuggest(){document.getElementById("suggestList").style.display="none"}function handleSuggestList(e){var t=document.getElementById("suggestList"),n=document.getElementById("SearchInput");if("block"===t.style.display){for(var o=-1,c=0;c<t.childNodes.length;++c)if("suggestItem_keyselect"===t.childNodes[c].getAttribute("class")){o=c;break}"38"==e.keyCode&&(0<=o&&o<t.childNodes.length&&t.childNodes[o].setAttribute("class","suggestItem"),0<=o-1&&o-1<t.childNodes.length?(n.value=t.childNodes[o-1].innerHTML,t.childNodes[o-1].setAttribute("class","suggestItem_keyselect")):n.value=n.getAttribute("UserInputValue")),"40"==e.keyCode&&(0<=o&&o<t.childNodes.length&&t.childNodes[o].setAttribute("class","suggestItem"),0<=o+1&&o+1<t.childNodes.length?(n.value=t.childNodes[o+1].innerHTML,t.childNodes[o+1].setAttribute("class","suggestItem_keyselect")):n.value=n.getAttribute("UserInputValue"))}}function isArray(e){return"[object Array]"==Object.prototype.toString.call(e)}function initAnalytics(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://ssl.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t);for(var n=document.querySelectorAll("button"),o=0;o<n.length;++o)n[o].addEventListener("click",function(e){0<this.innerText.length&&_gaq.push(["_trackEvent",this.innerText,"clicked"])})}_gaq.push(["_setAccount","UA-116149262-2"]),_gaq.push(["_trackPageview"]),window.addEventListener("load",function(){init()});